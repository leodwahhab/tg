<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/MIGRATION_CODIGO_ESTACAO.md">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/MIGRATION_CODIGO_ESTACAO.md" />
              <option name="updatedContent" value="# Migration: Adicionar Coluna 'codigo' na Tabela Estacao&#10;&#10;##  Resumo&#10;&#10;Foi criada uma migration para adicionar a coluna `codigo` na tabela `estacao`, permitindo identificar cada estação por sua sigla de 3 letras (ex: OSA, PIN, VAG).&#10;&#10;---&#10;&#10;##  Mudanças Implementadas&#10;&#10;### 1. **Migration** (`f0c499b13e33_adicionar_coluna_codigo_estacao.py`)&#10;&#10;#### upgrade():&#10;1. ✅ Adiciona coluna `codigo` VARCHAR(3) (nullable temporariamente)&#10;2. ✅ Popula os códigos de todas as 42 estações existentes&#10;3. ✅ Torna a coluna NOT NULL após popular os dados&#10;4. ✅ Cria índice único em `codigo` para buscas rápidas&#10;&#10;#### downgrade():&#10;- Remove o índice e a coluna `codigo`&#10;&#10;### 2. **Modelo Estacao** (`models.py`)&#10;&#10;```python&#10;class Estacao(Base):&#10;    __tablename__ = 'estacao'&#10;&#10;    id = Column(Integer, primary_key=True, autoincrement=True)&#10;    codigo = Column(String(3), nullable=False, unique=True, index=True)  # NOVO&#10;    nome = Column(String(50), nullable=False)&#10;    latitude = Column(Double, nullable=False)&#10;    longitude = Column(Double, nullable=False)&#10;```&#10;&#10;### 3. **Novas Rotas** (`estacao_routes.py`)&#10;&#10;#### GET `/estacao/listar`&#10;Lista todas as estações com seus códigos.&#10;&#10;**Response:**&#10;```json&#10;{&#10;  &quot;total&quot;: 42,&#10;  &quot;estacoes&quot;: [&#10;    {&#10;      &quot;id&quot;: 1,&#10;      &quot;codigo&quot;: &quot;JPR&quot;,&#10;      &quot;nome&quot;: &quot;Júlio Prestes&quot;,&#10;      &quot;latitude&quot;: 0.0,&#10;      &quot;longitude&quot;: 0.0&#10;    },&#10;    ...&#10;  ]&#10;}&#10;```&#10;&#10;#### GET `/estacao/buscar/{codigo}`&#10;Busca uma estação específica pelo código.&#10;&#10;**Exemplo:** `/estacao/buscar/OSA`&#10;&#10;**Response:**&#10;```json&#10;{&#10;  &quot;id&quot;: 7,&#10;  &quot;codigo&quot;: &quot;OSA&quot;,&#10;  &quot;nome&quot;: &quot;Osasco&quot;,&#10;  &quot;latitude&quot;: 0.0,&#10;  &quot;longitude&quot;: 0.0&#10;}&#10;```&#10;&#10;**Error 404:**&#10;```json&#10;{&#10;  &quot;detail&quot;: &quot;Estação com código 'XXX' não encontrada&quot;&#10;}&#10;```&#10;&#10;---&#10;&#10;##  Códigos das Estações&#10;&#10;### Linha 8 (Diamante) - 23 estações&#10;```&#10;JPR - Júlio Prestes&#10;BFU - Palmeiras - Barra Funda&#10;LAB - Lapa&#10;DMO - Domingos de Moraes&#10;ILE - Imperatriz Leopoldina&#10;PAL - Presidente Altino&#10;OSA - Osasco&#10;CSA - Comandante Sampaio&#10;QTU - Quitaúna&#10;GMC - General Miguel Costa&#10;CPB - Carapicuíba&#10;STE - Santa Terezinha&#10;AJO - Antonio João&#10;BRU - Barueri&#10;JBE - Jardim Belval&#10;JSI - Jardim Silveira&#10;JDI - Jandira&#10;SCO - Sagrado Coração&#10;ECD - Engenheiro Cardoso&#10;IPV - Itapevi&#10;SRT - Santa Rita&#10;AMB - Ambuitá&#10;ABU - Amador Bueno&#10;```&#10;&#10;### Linha 9 (Esmeralda) - 21 estações&#10;```&#10;VAG - Varginha&#10;MVN - Bruno Covas - Mendes - Vila Natal&#10;GRA - Grajaú&#10;INT - Primavera - Interlagos&#10;AUT - Autódromo&#10;JUR - Jurubatuba - Senac&#10;SOC - Socorro&#10;SAM - Santo Amaro&#10;GJT - Granja Julieta&#10;MRB - Morumbi - Claro&#10;BRR - Berrini&#10;VOL - Vila Olímpia&#10;CJD - Cidade Jardim&#10;HBR - Hebraica - Rebouças&#10;PIN - Pinheiros&#10;USP - Cidade Universitária&#10;JAG - Villa Lobos - Jaguaré&#10;CEA - Ceasa&#10;JOD - João Dias&#10;PAL - Presidente Altino&#10;OSA - Osasco&#10;```&#10;&#10;### Estações Compartilhadas (L8 e L9)&#10;- **PAL** - Presidente Altino&#10;- **OSA** - Osasco&#10;&#10;---&#10;&#10;##  Como Usar&#10;&#10;### 1. Listar todas as estações&#10;```bash&#10;curl -X GET http://localhost:8000/estacao/listar \&#10;  -H &quot;Authorization: Bearer {token}&quot;&#10;```&#10;&#10;### 2. Buscar estação específica&#10;```bash&#10;curl -X GET http://localhost:8000/estacao/buscar/OSA \&#10;  -H &quot;Authorization: Bearer {token}&quot;&#10;```&#10;&#10;### 3. Consultar próximo trem (já existente)&#10;```bash&#10;curl -X GET &quot;http://localhost:8000/estacao/proximo-trem?linha=L8&amp;estacao=OSA&quot; \&#10;  -H &quot;Authorization: Bearer {token}&quot;&#10;```&#10;&#10;---&#10;&#10;##  Exemplos com Python&#10;&#10;### Listar todas as estações&#10;```python&#10;import requests&#10;&#10;headers = {&quot;Authorization&quot;: f&quot;Bearer {token}&quot;}&#10;response = requests.get(&quot;http://localhost:8000/estacao/listar&quot;, headers=headers)&#10;&#10;estacoes = response.json()[&quot;estacoes&quot;]&#10;for estacao in estacoes:&#10;    print(f&quot;{estacao['codigo']} - {estacao['nome']}&quot;)&#10;```&#10;&#10;### Buscar estação por código&#10;```python&#10;codigo = &quot;OSA&quot;&#10;response = requests.get(&#10;    f&quot;http://localhost:8000/estacao/buscar/{codigo}&quot;,&#10;    headers=headers&#10;)&#10;&#10;if response.status_code == 200:&#10;    estacao = response.json()&#10;    print(f&quot;Estação encontrada: {estacao['nome']}&quot;)&#10;else:&#10;    print(f&quot;Estação não encontrada: {response.json()['detail']}&quot;)&#10;```&#10;&#10;---&#10;&#10;## ✅ Benefícios&#10;&#10;1. **Busca Rápida**: Índice único na coluna `codigo` para queries otimizadas&#10;2. **Identificação Padrão**: Usa os códigos oficiais da ViaMobilidade&#10;3. **API Consistente**: Mantém compatibilidade com endpoints existentes&#10;4. **Dados Completos**: Todos os 42 códigos mapeados corretamente&#10;5. **Validação**: Coluna NOT NULL e UNIQUE garante integridade&#10;&#10;---&#10;&#10;##  Ordem das Migrations&#10;&#10;1. `523b3eced7b3` - Alteração tabela viagem&#10;2. `236e506eb777` - Correção tipo coluna nome (linha)&#10;3. `6dbbe4e1190d` - Popular linhas e estações&#10;4. `f0c499b13e33` - **Adicionar coluna codigo (HEAD)** ✨&#10;&#10;---&#10;&#10;##  Reverter a Migration&#10;&#10;Para reverter a adição da coluna codigo:&#10;&#10;```bash&#10;alembic downgrade -1&#10;```&#10;&#10;Isso irá:&#10;- Remover o índice `ix_estacao_codigo`&#10;- Remover a coluna `codigo` da tabela `estacao`&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/test_viagem_api.py">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/test_viagem_api.py" />
              <option name="updatedContent" value="&quot;&quot;&quot;&#10;Script de teste para a API de embarque&#10;&quot;&quot;&quot;&#10;import requests&#10;from datetime import datetime&#10;&#10;BASE_URL = &quot;http://localhost:8000&quot;&#10;&#10;def testar_fluxo_completo():&#10;    &quot;&quot;&quot;Testa o fluxo completo: login -&gt; registrar embarque&quot;&quot;&quot;&#10;    &#10;    print(&quot;=&quot; * 60)&#10;    print(&quot;TESTE: Fluxo Completo de Registro de Embarque&quot;)&#10;    print(&quot;=&quot; * 60)&#10;    &#10;    # 1. Fazer login&#10;    print(&quot;\n1. Fazendo login...&quot;)&#10;    login_data = {&#10;        &quot;email&quot;: &quot;teste@example.com&quot;,&#10;        &quot;senha&quot;: &quot;senha123&quot;&#10;    }&#10;    &#10;    try:&#10;        login_response = requests.post(&#10;            f&quot;{BASE_URL}/auth/login&quot;,&#10;            json=login_data&#10;        )&#10;        &#10;        if login_response.status_code == 200:&#10;            token = login_response.json()[&quot;access_token&quot;]&#10;            print(f&quot;✅ Login bem-sucedido!&quot;)&#10;            print(f&quot;   Token: {token[:30]}...&quot;)&#10;        else:&#10;            print(f&quot;❌ Erro no login: {login_response.status_code}&quot;)&#10;            print(f&quot;   Detalhes: {login_response.json()}&quot;)&#10;            return&#10;            &#10;    except Exception as e:&#10;        print(f&quot;❌ Erro ao fazer login: {str(e)}&quot;)&#10;        return&#10;    &#10;    # 2. Registrar embarque&#10;    print(&quot;\n2. Registrando embarque...&quot;)&#10;    headers = {&#10;        &quot;Authorization&quot;: f&quot;Bearer {token}&quot;&#10;    }&#10;    &#10;    embarque_data = {&#10;        &quot;id_viagem&quot;: 1,&#10;        &quot;id_estacao&quot;: 7,  # Osasco&#10;        &quot;horario_embarque&quot;: datetime.now().isoformat()&#10;    }&#10;    &#10;    try:&#10;        embarque_response = requests.post(&#10;            f&quot;{BASE_URL}/viagem/embarque&quot;,&#10;            json=embarque_data,&#10;            headers=headers&#10;        )&#10;        &#10;        if embarque_response.status_code == 200:&#10;            resultado = embarque_response.json()&#10;            print(f&quot;✅ Embarque registrado com sucesso!&quot;)&#10;            print(f&quot;   Usuário: {resultado['id_usuario']}&quot;)&#10;            print(f&quot;   Viagem: {resultado['id_viagem']}&quot;)&#10;            print(f&quot;   Estação: {resultado['id_estacao']}&quot;)&#10;            print(f&quot;   Horário: {resultado['horario_embarque']}&quot;)&#10;        else:&#10;            print(f&quot;❌ Erro ao registrar embarque: {embarque_response.status_code}&quot;)&#10;            print(f&quot;   Detalhes: {embarque_response.json()}&quot;)&#10;            &#10;    except Exception as e:&#10;        print(f&quot;❌ Erro ao registrar embarque: {str(e)}&quot;)&#10;    &#10;    # 3. Tentar registrar novamente (deve falhar)&#10;    print(&quot;\n3. Tentando registrar embarque duplicado...&quot;)&#10;    try:&#10;        embarque_response2 = requests.post(&#10;            f&quot;{BASE_URL}/viagem/embarque&quot;,&#10;            json=embarque_data,&#10;            headers=headers&#10;        )&#10;        &#10;        if embarque_response2.status_code == 400:&#10;            print(f&quot;✅ Duplicação corretamente bloqueada!&quot;)&#10;            print(f&quot;   Mensagem: {embarque_response2.json()['detail']}&quot;)&#10;        else:&#10;            print(f&quot;⚠️ Resposta inesperada: {embarque_response2.status_code}&quot;)&#10;            &#10;    except Exception as e:&#10;        print(f&quot;❌ Erro: {str(e)}&quot;)&#10;    &#10;    # 4. Tentar sem token (deve falhar)&#10;    print(&quot;\n4. Tentando registrar sem token...&quot;)&#10;    try:&#10;        embarque_response3 = requests.post(&#10;            f&quot;{BASE_URL}/viagem/embarque&quot;,&#10;            json=embarque_data&#10;        )&#10;        &#10;        if embarque_response3.status_code == 401:&#10;            print(f&quot;✅ Acesso corretamente negado sem token!&quot;)&#10;            print(f&quot;   Mensagem: {embarque_response3.json()['detail']}&quot;)&#10;        else:&#10;            print(f&quot;⚠️ Resposta inesperada: {embarque_response3.status_code}&quot;)&#10;            &#10;    except Exception as e:&#10;        print(f&quot;❌ Erro: {str(e)}&quot;)&#10;    &#10;    print(&quot;\n&quot; + &quot;=&quot; * 60)&#10;    print(&quot;Testes concluídos!&quot;)&#10;    print(&quot;=&quot; * 60)&#10;&#10;&#10;if __name__ == &quot;__main__&quot;:&#10;    testar_fluxo_completo()&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/verificar_codigos_estacoes.py">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/verificar_codigos_estacoes.py" />
              <option name="updatedContent" value="&quot;&quot;&quot;Script para verificar os códigos das estações&quot;&quot;&quot;&#10;from sqlalchemy import create_engine, text&#10;&#10;db = create_engine('postgresql://postgres:postgres@localhost:5432/postgres')&#10;&#10;with db.connect() as conn:&#10;    print(&quot;=== ESTAÇÕES COM CÓDIGOS (primeiras 15) ===&quot;)&#10;    result = conn.execute(text(&quot;SELECT id, codigo, nome FROM estacao ORDER BY id LIMIT 15&quot;))&#10;    for row in result:&#10;        print(f&quot;ID: {row[0]:2d} | Código: {row[1]:3s} | Nome: {row[2]}&quot;)&#10;    &#10;    print(&quot;\n=== TOTAL DE ESTAÇÕES ===&quot;)&#10;    result = conn.execute(text(&quot;SELECT COUNT(*) FROM estacao&quot;))&#10;    total = result.scalar()&#10;    print(f&quot;Total: {total} estações&quot;)&#10;    &#10;    print(&quot;\n=== VERIFICAR SE TODOS TÊM CÓDIGO ===&quot;)&#10;    result = conn.execute(text(&quot;SELECT COUNT(*) FROM estacao WHERE codigo IS NULL&quot;))&#10;    sem_codigo = result.scalar()&#10;    if sem_codigo == 0:&#10;        print(&quot;✅ Todas as estações têm código!&quot;)&#10;    else:&#10;        print(f&quot;❌ {sem_codigo} estações sem código&quot;)&#10;    &#10;    print(&quot;\n=== VERIFICAR UNICIDADE DOS CÓDIGOS ===&quot;)&#10;    result = conn.execute(text(&quot;&quot;&quot;&#10;        SELECT codigo, COUNT(*) as qtd &#10;        FROM estacao &#10;        GROUP BY codigo &#10;        HAVING COUNT(*) &gt; 1&#10;    &quot;&quot;&quot;))&#10;    duplicados = result.fetchall()&#10;    if not duplicados:&#10;        print(&quot;✅ Todos os códigos são únicos!&quot;)&#10;    else:&#10;        print(f&quot;❌ Códigos duplicados:&quot;)&#10;        for row in duplicados:&#10;            print(f&quot;   {row[0]}: {row[1]} vezes&quot;)&#10;    &#10;    print(&quot;\n=== ESTAÇÕES COMPARTILHADAS (L8 e L9) ===&quot;)&#10;    result = conn.execute(text(&quot;&quot;&quot;&#10;        SELECT e.codigo, e.nome, COUNT(DISTINCT le.id_linha) as num_linhas&#10;        FROM estacao e&#10;        JOIN linha_estacao le ON e.id = le.id_estacao&#10;        GROUP BY e.id, e.codigo, e.nome&#10;        HAVING COUNT(DISTINCT le.id_linha) &gt; 1&#10;        ORDER BY e.codigo&#10;    &quot;&quot;&quot;))&#10;    compartilhadas = result.fetchall()&#10;    if compartilhadas:&#10;        print(f&quot;Total: {len(compartilhadas)} estações&quot;)&#10;        for row in compartilhadas:&#10;            print(f&quot;   {row[0]} - {row[1]} ({row[2]} linhas)&quot;)&#10;    else:&#10;        print(&quot;Nenhuma estação compartilhada entre linhas&quot;)&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/verificar_dados.py">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/verificar_dados.py" />
              <option name="updatedContent" value="&quot;&quot;&quot;Script para verificar os dados inseridos no banco&quot;&quot;&quot;&#10;from sqlalchemy import create_engine, text&#10;&#10;db = create_engine('postgresql://postgres:postgres@localhost:5432/postgres')&#10;&#10;with db.connect() as conn:&#10;    # Verificar linhas&#10;    print(&quot;=== LINHAS ===&quot;)&#10;    result = conn.execute(text(&quot;SELECT id, nome, numero, cor_hex FROM linha ORDER BY id&quot;))&#10;    for row in result:&#10;        print(f&quot;ID: {row[0]}, Nome: {row[1]}, Número: {row[2]}, Cor: #{row[3]}&quot;)&#10;    &#10;    print(&quot;\n=== ESTAÇÕES (primeiras 10) ===&quot;)&#10;    result = conn.execute(text(&quot;SELECT id, nome FROM estacao ORDER BY id LIMIT 10&quot;))&#10;    for row in result:&#10;        print(f&quot;ID: {row[0]}, Nome: {row[1]}&quot;)&#10;    &#10;    print(&quot;\n=== TOTAL DE ESTAÇÕES ===&quot;)&#10;    result = conn.execute(text(&quot;SELECT COUNT(*) FROM estacao&quot;))&#10;    total = result.scalar()&#10;    print(f&quot;Total: {total} estações&quot;)&#10;    &#10;    print(&quot;\n=== RELACIONAMENTOS LINHA-ESTAÇÃO (primeiros 10) ===&quot;)&#10;    result = conn.execute(text(&quot;&quot;&quot;&#10;        SELECT le.id_linha, l.nome, le.id_estacao, e.nome, le.ordem &#10;        FROM linha_estacao le&#10;        JOIN linha l ON le.id_linha = l.id&#10;        JOIN estacao e ON le.id_estacao = e.id&#10;        ORDER BY le.id_linha, le.ordem&#10;        LIMIT 10&#10;    &quot;&quot;&quot;))&#10;    for row in result:&#10;        print(f&quot;Linha {row[0]} ({row[1]}) - Estação {row[2]} ({row[3]}) - Ordem: {row[4]}&quot;)&#10;    &#10;    print(&quot;\n=== TOTAL DE RELACIONAMENTOS ===&quot;)&#10;    result = conn.execute(text(&quot;SELECT COUNT(*) FROM linha_estacao&quot;))&#10;    total = result.scalar()&#10;    print(f&quot;Total: {total} relacionamentos&quot;)&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>